---
title: "RProject"
author: "Amy Lang(S2127213), Chen Yu Qi (17068721), Yeoh Li Tian(s2120306), Puveemalr Parameswaran(s2127371), Qi Han(s2123517)"
date: "6/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction(Puvee)
## Load Libraries
```{r import library}
library(ggplot2)
library(dplyr)
library(scales)
library(tidyr)
library(rstudioapi)
```

## Load Dataset
YLT: I changed this part, now u can just run and the path is set automatically
```{r load dataset}
main_dir<- dirname(dirname(rstudioapi::getSourceEditorContext()$path))
datadir<- paste0(main_dir,"/data")
data_path<- paste0(datadir,"/data.csv")

df=read.csv(data_path)
head(df)
```

## Explore Dataset
```{r data set characteristics}
str(df)
```
There are 13 variables and 435742 row of observations in total.

```{r data set characteristics1}
summary(df)
```
Stn_code, sampling_date, state, location, agency, type, location_monitoring_station and date is labelled as character variables.

so2,no2,rspm,spm and pm2_5 are numerical variables with missing values and maybe outliers because of abnormal large maximum value. 

```{r data set characteristics2}
for(i in 1:13){
  x=sum(is.na(df[i]))
  print(paste(names(df[i]),x))
}
```
There are missing value except state variable.

## Drop Unnecessary Variables

Since "sampling_date" carry same meaning as "date", we may drop it. 

stn_code, agency and location_monitoring_station also seen carry same meaning with location and state, we may drop it too.
```{r drop sampling_date}
df$sampling_date=NULL
df$stn_code=NULL
df$agency=NULL
df$location_monitoring_station=NULL
head(df)
```


# Exploratary Data Analysis - Univariate

Let's observe the other variables one by one. 


### 1. State
```{r plot state}
plotdata <- df %>%
  count(state) %>%
  mutate(pct = n / sum(n),
         pctlabel = paste0(round(pct*100), "%"))
plotdata

p1<-ggplot(plotdata, aes(x=reorder(state, n),y=pct)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label = pctlabel), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = percent) +
  labs(y = "Percentage",x="State", title = "Percentage of Recording From Each State")
p1

```


Maharashtra have most observations followed by Uttar Pradesh and others. 


### 2.Location 
```{r plot Location}
plotdata <- df %>%
  count(location) %>%
  mutate(pct = n / sum(n),
         pctlabel = paste0(round(pct*100), "%"))
plotdata

p1<-ggplot(plotdata, aes(x = reorder(location, n),y=pct)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label = pctlabel), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_y_continuous(labels = percent) +
  labs(y = "Percentage", x = "Location", title = "Percentage of Recording From Each Location")
p1
```

There are 305 distinct value for Location variable. Guwahati is the largest class. There are 3 missing value, we may drop it later. 

### 3. Type
```{r plot Type}
plotdata <- df %>%
  count(type) %>%
  mutate(pct = n / sum(n),
         pctlabel = paste0(round(pct*100), "%"))
plotdata

p1<-ggplot(plotdata, aes(x = reorder(type, n), y=pct)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label = pctlabel), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = percent) +
  labs(y = "Percentage", x="Area Type", title = "Percentage of Recording From Each Type of Area")
p1
```

We can group the data into "residual", "industrial" and "others" class. 


```{r plot Type1}
df$type[df$type %in% "Residential, Rural and other Areas"] <- "Residential"
df$type[df$type %in% "Residential and others"] <- "Residential"
df$type[df$type %in% "Industrial Area"] <- "Industrial"
df$type[df$type %in% "Industrial Areas"] <- "Industrial"
df$type[df$type %in% "RIRUO"] <- "Others"
df$type[df$type %in% "Sensitive"] <- "Others"
df$type[df$type %in% "Sensitive Areas"] <- "Others"
df$type[df$type %in% "Sensitive Area"] <- "Others"
df$type[is.na(df$type)]= "Others"
```


```{r plot Type2}
plotdata <- df %>%
  count(type) %>%
  mutate(pct = n / sum(n),
         pctlabel = paste0(round(pct*100), "%"))
plotdata

p1<-ggplot(plotdata, aes(x = reorder(type, n), y=pct)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label = pctlabel), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = percent) +
  labs(y = "Percentage", x="Area Type", title = "Percentage of Recording From Each Type of Area")
p1
```

Now there is only 3 groups in area type.

### 4. Sulfur dioxide (SO2)
```{r plot so2-1}
p1<-ggplot(df, aes(x = so2)) +
  geom_histogram(binwidth=0.1, colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of so2")
p1
```


There are 34646 rows of missing value in "so2".   

We can try focus on range(0~100) for drawing graph. 

```{r plot so2-2}
p1<-ggplot(df, aes(x = so2)) +
  geom_histogram(binwidth=0.1, breaks= seq(0,100), colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of so2")
p1
```

```{r plot so2-3}
boxplot(df$so2,
main = "Boxplot for so2",
col = "orange",
border = "brown",
horizontal = TRUE,
notch = TRUE
)
```

We can observe that the data is right skewed, data scattered around low value of so2 value. 

There are outliers in the dataset, we will be cleaning it later.

### 5. Nitrogen dioxide (nO2)
```{r plot no2-1}
p1<-ggplot(df, aes(x = no2)) +
  geom_histogram(binwidth=1, colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of no2")
p1
```


There are 16233 rows of missing value in “no2”.

We can try focus on range(0~200) for drawing graph.

```{r plot no2-2}
p1<-ggplot(df, aes(x = no2)) +
  geom_histogram(binwidth=1, breaks= seq(0,200),colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of no2")
p1
```

```{r plot no2-3}
boxplot(df$no2,
main = "Boxplot for no2",
col = "orange",
border = "brown",
horizontal = TRUE,
notch = TRUE
)
```

We can observe that the data is right skewed, data scattered around low value of no2 value.

There are outliers in the dataset, we will be cleaning it later.

### 6. Respirable Suspended Particulate Matter (rspm)
```{r plot rspm-1}
p1<-ggplot(df, aes(x = rspm)) +
  geom_histogram(binwidth=10, colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of rspm")
p1
```


There are 40222 rows of missing value in “rspm”.

We can try focus on range(0~1000) for drawing graph.
```{r plot rspm-2}
p1<-ggplot(df, aes(x = rspm)) +
  geom_histogram(binwidth=100,  breaks= seq(0,1000), fill = "lightgreen")+
  labs(title = "HIstogram of rspm")
p1
```


```{r plot rspm-3}
boxplot(df$rspm,
main = "Boxplot for rspm",
col = "orange",
border = "brown",
horizontal = TRUE,
notch = TRUE
)
```


We can observe that the data is right skewed, data scattered around low value of rspm value.

There are outliers in the dataset, we will be cleaning it later.


### 7. Suspended particulate matter (spm)
```{r plot spm-1}
p1<-ggplot(df, aes(x = spm)) +
  geom_histogram(binwidth=1, colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of spm")
p1
```


There are 237387 rows of missing value in “spm”.

We can try focus on range(0~1000) for drawing graph.

```{r plot spm-2}
p1<-ggplot(df, aes(x = spm)) +
  geom_histogram(binwidth=100, breaks= seq(0,1000) ,fill = "lightgreen")+
  labs(title = "HIstogram of spm")
p1
```

```{r plot spm-3}
boxplot(df$spm,
main = "Boxplot for spm",
col = "orange",
border = "brown",
horizontal = TRUE,
notch = TRUE
)
```


We can observe that the data is right skewed, data scattered around low value of spm value.

There are outliers in the dataset, we will be cleaning it later.

### 8. Fine particulate matter (pm2.5)
```{r plot pm2_5-1}

##pm2_5
p1<-ggplot(df, aes(x = pm2_5)) +
  geom_histogram(binwidth=0.5, colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of pm2.5")
p1
```


There are 426428 rows of missing value in “pm2_5”.

We can try focus on range(0~300) for drawing graph.

```{r plot pm2_5-2}
p1<-ggplot(df, aes(x = pm2_5)) +
  geom_histogram(binwidth=0.5, breaks= seq(0,300), colour="black", fill = "lightgreen")+
  labs(title = "HIstogram of pm2.5")
p1
```

```{r plot pm2_5-3}
boxplot(df$pm2_5,
main = "Boxplot for pm2_5",
col = "orange",
border = "brown",
horizontal = TRUE,
notch = TRUE
)
```


We can observe that the data is right skewed, data scattered around low value of pm2_5 value.

There are outliers in the dataset, we will be cleaning it later.



# Cleaning Outliers

```{r remove outliers and plot}

df <- df %>% mutate(so2 = if_else(so2>500, mean(df$so2), df$so2))
df <- df %>% mutate(no2 = if_else(no2>500, mean(df$no2), df$no2))
df <- df %>% mutate(rspm = if_else(rspm>2000, mean(df$rspm), df$rspm))
df <- df %>% mutate(spm = if_else(spm>2000, mean(df$spm), df$spm))
df <- df %>% mutate(pm2_5 = if_else(pm2_5>350, mean(df$pm2_5), df$pm2_5))

par(mfrow=c(1,5))

boxplot(df$so2,
        main = "Boxplot for so2",
        col = "orange",
        border = "brown",
        notch = TRUE)

boxplot(df$no2,
        main = "Boxplot for no2",
        col = "orange",
        border = "brown",
        notch = TRUE)

boxplot(df$rspm,
        main = "Boxplot for rspm",
        col = "orange",
        border = "brown",
        notch = TRUE)

boxplot(df$spm,
        main = "Boxplot for spm",
        col = "orange",
        border = "brown",
        notch = TRUE)

boxplot(df$pm2_5,
        main = "Boxplot for pm2_5",
        col = "orange",
        border = "brown",
        notch = TRUE)
```

The outliers has been removed. 


#  Create Subset

Because we want to build two models,

i) time series regression for predicting pm2.5 for year 2014 and 2015. 

ii) clustering using all data. 
so, we first make a subset for first model and clean it. 

## 1. Create Subset for Time Series Regression Model

```{r plot subset1}
df_ts=subset(df, !is.na(pm2_5))
head(df_ts)
str(df_ts)
```

There is only 9314 rows that have pm2.5 value.  

### Cleaning Missing Values

```{r plot subset missing value 1}
for(i in 1:9){
  x=sum(is.na(df_ts[i]))
  print(paste(names(df_ts[i]),x))}
```

so2,no2,rspm have missing values. spm is blank. 

```{r plot subset cleaning 1}
df_ts$so2[is.na(df_ts$so2)]= mean(df_ts$so2, na.rm = TRUE)
df_ts$no2[is.na(df_ts$no2)]= mean(df_ts$no2, na.rm = TRUE)
df_ts$rspm[is.na(df_ts$rspm)]= mean(df_ts$rspm, na.rm = TRUE)
df_ts$spm=NULL

for(i in 1:8){
  x=sum(is.na(df_ts[i]))
  print(paste(names(df_ts[i]),x))}
```

There is no missing value now and we can export this subset out for visualization and modelling of time series regression. 


### Rearrange According To Date

```{r rearrange}
df_ts=df_ts[(order(df_ts$date,decreasing=FALSE)),]
```

```{r subset stat}
head(df_ts)
str(df_ts)
```

### Export Subset 1

```{r export subset csv}
#write.csv(df_ts,"data_ts.csv", row.names=FALSE)
```


### Time Series Plot 

```{r}
#check the data of noPmNA
table(df_ts$state)
```
```{r}
#change the type of "date" to date for the convenience of drawing
df_ts$date<-as.Date(df_ts$date)
```

```{r}
#split the dataset
splitByState <- split(df_ts, df_ts$state)
str(splitByState)
```

```{r}
library(ggplot2)

for (i in 1:length(splitByState)){
  loopdata<-splitByState[[i]]
  #print(loopdata)
  #print(as.character(names(splitByState[i])))
  #draw graph
  print(ggplot() +geom_line(data = loopdata,aes(x = date,y = pm2_5,colour = "pm2_5"),size=1) +
  geom_line(data = loopdata,aes(x = date,y = so2,colour = "so2"),size=1) +
  geom_line(data = loopdata,aes(x = date,y = no2,colour = "no2"),size=1) +
  geom_line(data = loopdata,aes(x = date,y = rspm,colour = "rspm"),size=1) +
  ggtitle(paste("State:",as.character(names(splitByState[i])))) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_colour_manual("",values = c("pm2_5" = "red","so2"="green","no2"="blue","rspm"="yellow"))+
  xlab("Date")+ylab("Pollution"))
}


```



## 2. Create Subset for Clustering Model

```{r plot subset2}
df_c=df
df_c$pm2_5=NULL
df_c$date=NULL
head(df_c)
```

We dropped pm2.5 because it is the target variable and it is only avaliable for last 2 year. 
We dropped date because clustering model no need time variable. 

### Cleaning Missing Values

```{r plot subset2 missing value 1}
for(i in 1:7){
  x=sum(is.na(df_c[i]))
  print(paste(names(df_c[i]),x))}
```

location, so2,no2,rspm and spm have missing values

```{r plot subset2 cleaning 1}
df_c$so2[is.na(df$so2)]= mean(df_c$so2, na.rm = TRUE)
df_c$no2[is.na(df$no2)]= mean(df_c$no2, na.rm = TRUE)
df_c$rspm[is.na(df$rspm)]= mean(df_c$rspm, na.rm = TRUE)
df_c$spm[is.na(df$spm)]= mean(df_c$spm, na.rm = TRUE)
df_c <- df_c %>% na.omit(df_c)

for(i in 1:7){
  x=sum(is.na(df_c[i]))
  print(paste(names(df_c[i]),x))}

```

We mutate missing value in numerical variable using mean. 3 missing value for location, we just drop. 
There is no more missing values in the dataset, it is ready to export. 

```{r subset2 stat}
head(df_c)
str(df_c)
```

### Export Subset 2

```{r export subset2 csv}
data_c_path = paste0(datadir, "/data_c.csv")
write.csv(df_c, data_c_path, row.names=FALSE)
```




### Exploratory Data Analysis - Multivariate  

### 1. correlation

```{r plot correlation}
pairs(~ so2 + no2 + rspm + spm, data=df_c, col = 'blue')
plot(df_c)
```

RSPM and SPM seem to have slightly stonger positive relationship while the others variables seem like having poor positive relationship. 

### 2. Bivarite plot

#### So2 with state
```{r plot so2 state}
plotdata <- df_c %>%
  group_by(state) %>%
  summarize(mean_1 = mean(so2))
plotdata
ggplot(plotdata, aes(x = reorder(state, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "So2 by state", y = "Mean of SO2", x ="State")
```

Jharkhand have the highest SO2 concentration in the air followed by Uttaranchal and Uttarakhand.


#### So2 with type
```{r plot so2 type}
plotdata <- df_c %>%
  group_by(type) %>%
  summarize(mean_1 = mean(so2))
plotdata
ggplot(plotdata, aes(x = reorder(type, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "So2 by area type", y = "Mean of SO2", x ="Area Type")

```

Industrial area have highest So2 concentration.

#### No2 with state
```{r plot no2 state}
plotdata <- df_c %>%
  group_by(state) %>%
  summarize(mean_1 = mean(no2))
plotdata
ggplot(plotdata, aes(x = reorder(state, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "No2 by state", y = "Mean of NO2", x ="State")
```

West Bengal have the highest NO2 concentration in the air followed by Delhi and Jharkhand.

#### No2 with type
```{r plot no2 type}
plotdata <- df_c %>%
  group_by(type) %>%
  summarize(mean_1 = mean(no2))
plotdata
ggplot(plotdata, aes(x = reorder(type, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "No2 by area type", y = "Mean of NO2", x ="Area Type")
```

Industrial area have highest No2 concentration.

#### RSPM with state
```{r plot rspm state}
plotdata <- df_c %>%
  group_by(state) %>%
  summarize(mean_1 = mean(rspm))
plotdata
ggplot(plotdata, aes(x = reorder(state, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "RSPM by state", y = "Mean of RSPM", x ="State")
```

Punjab have the highest RSPM index followed by Delhi and Uttar Pradesh.

#### RSPM with type
```{r plot rspm type}
plotdata <- df_c %>%
  group_by(type) %>%
  summarize(mean_1 = mean(rspm))
plotdata
ggplot(plotdata, aes(x = reorder(type, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "RSPM by area type", y = "Mean of RSPM", x ="Area Type")
```

Industrial area have highest RSPM index. 



#### SPM with state
```{r plot spm state}
plotdata <- df_c %>%
  group_by(state) %>%
  summarize(mean_1 = mean(spm))
plotdata
ggplot(plotdata, aes(x = reorder(state, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "SPM by state", y = "Mean of SPM", x ="State")

```

Delhi have the highest SPM index followed by Uttar Pradesh and Uttarakhand.

#### SPM with type
```{r plot spm type}
plotdata <- df_c %>%
  group_by(type) %>%
  summarize(mean_1 = mean(spm))
plotdata
ggplot(plotdata, aes(x = reorder(type, mean_1), y = mean_1)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "SPM by area type", y = "Mean of SPM", x ="Area Type")
```

Industrial area have highest SPM index. 


## Modelling & Results & Evaluation()
## Time series, regression 
## Clustering

## Discussion ()

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
## Conclusion (Puvee)